<div class="card p-6">
    <!-- Header Row: Stock In + Buttons -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <span class="block text-surface-900 font-bold text-2xl">Invoice</span>

        <!-- Buttons - Hidden on mobile, shown in header on desktop -->
        <div class="hidden md:flex gap-4">
             <button pButton type="button" label="Customer Ledger" class="p-button-warning flex-1" [disabled]="invoiceForm.invalid" (click)="customerLedger()"></button>
            <button pButton type="button" label="Display" class="p-button-warning" [disabled]="invoiceForm.invalid" (click)="display()"></button>
            <button pButton type="submit" label="Submit" class="p-button-warning" (click)="submit()" [disabled]="submitDisable"></button>
            <button pButton type="button" label="Reset" class="p-button-secondary" (click)="reset()"></button>
        </div>
    </div>

    <form [formGroup]="invoiceForm" class="space-y-8">
        <!-- ðŸ· Product Info Section -->
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-x-8 gap-y-4 w-full">

                <!-- Transaction Date From-->
                <div class="flex flex-col">
                    <label class="font-medium mb-1">From Date <span class="text-red-500">*</span></label>
                    <p-datepicker fluid formControlName="fromDate" dateFormat="dd/mm/yy" [showIcon]="true" placeholder="From Date" class="w-full"> </p-datepicker>
                    <small class="text-red-500 ms-3 mt-1" *ngIf="invoiceForm.get('fromDate')?.touched">
                        <span *ngIf="invoiceForm.get('fromDate')?.errors?.['required']">From Date is required</span>
                    </small>
                </div>

                <!-- Transaction Date To -->
                <div class="flex flex-col">
                    <label class="font-medium mb-1">To Date <span class="text-red-500">*</span></label>
                    <p-datepicker fluid formControlName="toDate" dateFormat="dd/mm/yy" [showIcon]="true" placeholder="To Date" class="w-full"> </p-datepicker>
                    <small class="text-red-500 ms-3 mt-1" *ngIf="invoiceForm.get('toDate')?.touched">
                        <span *ngIf="invoiceForm.get('toDate')?.errors?.['required']">To Date is required</span>
                        <span *ngIf="invoiceForm.errors?.['dateRangeInvalid'] && invoiceForm.get('toDate')?.touched"> To Date must be greater than or equal to From Date </span>
                    </small>
                </div>

                <!-- Customer Name -->
                <div class="flex flex-col">
                    <label class="font-medium mb-1">Customer Name</label>
                    <p-dropdown
                        [options]="cusNameOptions"
                        optionLabel="fieldname"
                        optionValue="fieldid"
                        [filter]="true"
                        [showClear]="true"
                        filterPlaceholder="Search Customer Name"
                        formControlName="p_cusname"
                        placeholder="Customer Name"
                        class="w-full"
                    >
                    </p-dropdown>
                </div>

                  <!-- Customer Mobile -->
                <div class="flex flex-col">
                    <label class="font-medium mb-1">Customer Mobile</label>
                    <p-dropdown
                        [options]="cusMobileOptions"
                        optionLabel="fieldname"
                        optionValue="fieldid"
                        [filter]="true"
                        [showClear]="true"
                        filterPlaceholder="Search Customer Mobile"
                        formControlName="p_mobile"
                        placeholder="Customer Mobile"
                        class="w-full"
                    >
                    </p-dropdown>
                </div>
                
              <!-- Status -->
                <div class="flex flex-col">
                    <label class="font-medium mb-1">Status</label>
                    <p-dropdown [options]="statusOptions" optionLabel="fieldname" [showClear]="true" optionValue="fieldid" [filter]="true" filterPlaceholder="Select Status" formControlName="status" placeholder="Status" class="w-full"> </p-dropdown>
                </div>
                
                <!-- Total Due Amount -->
                <div class="flex flex-col">
                    <label class="font-medium mb-1">Total Due Amount</label>
                    <input pInputText placeholder="Total Due Amount" readonly class="grayout" formControlName="totalDueAmount" />
                </div>
               
</div>
            <!-- Action Buttons - Visible only on mobile, below Customer Name and Status -->
            <div class="flex md:hidden justify-center gap-4 mt-4">
                 <button pButton type="button" label="Customer Ledger" class="p-button-warning flex-1" [disabled]="invoiceForm.invalid" (click)="customerLedger()"></button>
                <button pButton type="button" label="Display" class="p-button-warning flex-1" [disabled]="invoiceForm.invalid" (click)="display()"></button>
                <button pButton type="submit" label="Submit" class="p-button-warning flex-1" (click)="submit()" [disabled]="submitDisable"></button>
                <button pButton type="button" label="Reset" class="p-button-secondary flex-1" (click)="reset()"></button>
            </div>
        </div>

        <!-- Product Table with Pagination -->
        <div>
            <p-table [value]="filteredProducts" dataKey="code" [tableStyle]="{ 'min-width': '50rem' }" [paginator]="true" [rows]="10" 
[rowsPerPageOptions]="[10, 20, 50]" [responsiveLayout]="'scroll'" class="p-datatable-gridlines mt-6 invoice">
                <ng-template #header>
                    <tr class="bg-yellow-400">
                        <th>Transaction Type</th>
                        <th>Invoice No</th>
                        <th>Invoice Date</th>
                        <th>Return Invoice No</th>
                        <th>Customer</th>
                        <th>Total Amount</th>
                        <th>Paid Amount</th>
                        <th class="flex gap-2"><p-checkbox binary="true" formControlName="p_checked" class="border" (change)="onDueAmountFilter($event)"></p-checkbox>Due Amount</th>
                        <th style="width: 140px; min-width: 160px; max-width: 160px">Received Amount</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-row let-i="rowIndex">
                    <tr>
                         <td>{{ row.transactiontype }}</td>
                        <td>{{ row.invoice_no }}</td>
                        <td>{{ row.invoice_date | date: 'dd/MM/yyyy' }}</td>
                        <td>{{ row.return_invoice_no}}</td>
                        <td>{{ row.customer }}</td>
                        <td>{{ row.total_amount | number: '1.2-2' }}</td>
                        <td>{{ row.paid_amount |number:'1.2-2'}}</td>
                        <td>{{ row.due_amount |number:'1.2-2'}}</td>
                        <td style="width: 140px; min-width: 160px; max-width: 160px">
                            <div class="grid items-center gap-2">
                                <input
                                    type="number"
                                    class="w-full"
                                    pInputText
                                    [disabled]="!canPrint(row) || row.status==='Cancel'" 
                                    [(ngModel)]="row.received_amount"
                                    (ngModelChange)="updateReceivedAmount(i, $event)"
                                    [ngModelOptions]="{ standalone: true }"
                                    (input)="validateReceivedAmount(row)"
                                    placeholder="Amount"
                                    (keydown)="blockMinus($event)"
                                />
                                <small class="text-red-500" *ngIf="row.amountError"> This cannot be greater than {{ row.due_amount }} </small>
                            </div>
                        </td>
                        <td>{{ row.status }}</td>
                        <td class="text-center w-[60px]">
                            <div class="flex g-2">
                                <button pButton type="button" icon="pi pi-print" class="p-button-text p-button-sm" printSectionId="invoicePrintSection" (click)="printInvoice(row)" [disabled]="!canPrint(row)"></button>
                                <button pButton type="button" icon="pi pi-folder-open" class="p-button-text p-button-sm text-red-500" (click)="openInvoice(row)" pTooltip="Open in Sale Page" tooltipPosition="top"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="paginatorleft">
                    <div class="total-items text-gray-600 ms-2">Total Items: {{ filteredProducts?.length || 0 }}</div>
                </ng-template>
            </p-table>
        </div>
    </form>

    <p-dialog header="Customer Ledger" [(visible)]="ledgerData" [modal]="true"  [style]="{width: '80vw'}">
        <p-table [value]="customerLedgerData" [responsiveLayout]="'scroll'" class="p-datatable-gridlines ledger">
            <ng-template pTemplate="header">
                <tr class="bg-yellow-400">
                    <th>Customer Name</th>
                    <th>Mobile No</th>
                    <th>Invoice No</th>
                    <th>Payment Date</th>   
                    <th>Payment Mode</th>
                     <th>Invoice Amount</th>
                     <th>Paid Amount</th>
                     <th>Remarks</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                  <td>{{ row.customername }}</td>
                  <td>{{ row.customerphone }}</td>
                  <td>{{ row.billno }}</td>
                  <td>{{ row.payment_date | date:'dd/MM/yyyy'}}</td>
                  <td>{{ row.payment_mode }}</td>
                  <td>{{ row.totalpayable }}</td>
                  <td>{{ row.paid_amount }}</td>
                  <td>{{ row.remarks }}</td>
                </tr>
            </ng-template>
        </p-table>
        <div class="flex justify-content-center md:justify-content-end mt-5">
        <button pButton type="button" label="Download" icon="pi pi-download" iconPos="right" class="p-button-warning" (click)="download()"></button>
        </div>
    </p-dialog>
    <!-- Confirm Dialog -->
    <p-confirmDialog></p-confirmDialog>
</div>

<!-- ================================
     PRINT SECTION (INVOICE)
================================= -->
<div id="invoicePrintSection" style=" width: 900px; margin: auto; font-family: Arial">
    <h3 style="text-align: center">TAX INVOICE</h3>

    <!-- ================= HEADER SECTION ================= -->
    <table width="100%" border="1" cellspacing="0" cellpadding="0" style="border-collapse: collapse; font-size:10px">
        <tr>
            <!-- LEFT SIDE (COMPANY + BUYER INFO) -->
            <td width="60%" style="vertical-align: top; padding: 6px">
                <strong>{{companyName}}</strong><br />
                {{companyAddress}},<br />
                {{companycity}}<br />
                GSTIN/UIN: {{companygstno}}<br />
                State Name: {{companystate}}, Code: {{statecode}}<br />
                E-Mail : {{companyemail }}
                <br />

                <hr style="margin: 5px 0" />

                <strong>Buyer (Bill to)</strong><br /><br />

                <strong>{{ invoiceForm.get('p_customername')?.value || '' }}</strong
                ><br />
                {{ invoiceForm.get('p_customeraddress')?.value || '' }}<br />
                Mobile: {{ invoiceForm.get('p_mobileno')?.value || '' }}<br />
                <br />

                GSTIN/UIN : {{ invoiceForm.get('p_customergstin')?.value || '' }}<br />
                State Name : {{ invoiceForm.get('p_customerstate')?.value || '' }}
            </td>

            <!-- RIGHT SECTION (INVOICE DETAILS) -->
            <td width="40%" style="vertical-align: top">
                <table width="100%" border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse">
                    <tr>
                        <td><strong>Invoice No.</strong></td>
                        <td>{{ invoiceForm.get('p_billno')?.value }}</td>
                    </tr>

                    <tr>
                        <td><strong>Dated</strong></td>
                        <td>{{ invoiceForm.get('p_transactiondate')?.value | date: 'dd-MMM-yy' }}</td>
                    </tr>

                    <tr>
                        <td>Delivery Note</td>
                        <td>-</td>
                    </tr>

                    <tr>
                        <td><strong>Mode of Payment</strong></td>
                        <td><strong>{{invoiceForm.get('p_paymode')}}</strong></td>
                    </tr>

                    <tr>
                        <td>Reference No. & Date</td>
                        <td>{{ invoiceForm.get('p_transactionid')?.value }} dt. {{ invoiceForm.get('p_transactiondate')?.value | date: 'dd-MMM-yy' }}</td>
                    </tr>

                    <tr>
                        <td>Other References</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Buyer's Order No.</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Dated</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Dispatch Doc No.</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Delivery Note Date</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Dispatched through</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Destination</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Terms of Delivery</td>
                        <td></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <!-- ================= ITEM TABLE ================= -->
    <table width="100%" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; font-size: 10px; margin-top: 10px">
        <thead>
            <tr style="text-align: center; font-weight: bold"></tr>
            <tr style="text-align: center; font-weight: bold">
                <td>Sl No.</td>
                <td>Description of Goods</td>
                <td>HSN/SAC</td>
                <td>Quantity</td>
                <td>Rate</td>
                <td>per</td>
                <td>Disc %</td>
                <td>Amount</td>
            </tr>
        </thead>

        <tbody>
            <tr *ngFor="let item of invoiceData; let i = index" style="text-align: center;">
                <td>{{ i + 1 }}</td>
                <td>{{ item.itemname }}</td>
                <td>{{item.hsncode}}</td>
                <td>{{ item.quantity }} {{ item.uomname }}</td>
                <td>â‚¹{{ item.mrp | number: '1.2-2' }}</td>
                <td>{{ item.uomname }}</td>
                <td>{{ item.discount || '' }}</td>
                <td>â‚¹{{ item.quantity * item.mrp | number: '1.2-2' }}</td>
            </tr>

            <!-- SUB TOTAL -->
            <tr>
                <td colspan="7" style="text-align: right; font-weight: bold">Total</td>
                <td>â‚¹{{ invoiceForm.get('p_totalsale')?.value | number: '1.2-2' }}</td>
                <!-- <td>â‚¹{{ invoiceForm.get('p_totalpayable')?.value | number:'1.2-2' }}</td> -->
            </tr>
            <tr>
                <td colspan="7" style="text-align: right; font-weight: bold">Discount {{ invoiceForm.get('p_disctype')?.value ? invoiceForm.get('p_overalldiscount')?.value + '%' : '' }}</td>

                <td>{{ !invoiceForm.get('p_disctype')?.value ? 'â‚¹' : '' }}{{ !invoiceForm.get('p_disctype')?.value ? invoiceForm.get('p_overalldiscount')?.value : 'â‚¹' + invoiceForm.get('discountvalueper')?.value }}</td>
            </tr>
            <!-- <tr *ngIf="invoiceForm.get('p_disctype')?.value==='Y'">
        <td colspan="7" style="text-align:right;font-weight:bold;"> Discount</td>
      
        <td>YES</td>
      </tr> -->

            <!-- CGST -->
            <!-- <tr>
        <td colspan="7" style="text-align:right;"><b>CGST</b></td>
        <td>{{ invoiceForm.get('p_cgst')?.value }}</td>
      </tr>

    
      <tr>
        <td colspan="7" style="text-align:right;"><b>SGST</b></td>
        <td>{{ invoiceForm.get('p_sgst')?.value }}</td>
      </tr> -->

            <!-- ROUND OFF -->
            <tr>
                <td colspan="7" style="text-align: right"><b>ROUND OFF +/-</b></td>
                <td>{{ invoiceForm.get('p_roundoff')?.value | number: '1.2-2' }}</td>
            </tr>
        </tbody>

        <!-- GRAND TOTAL -->
        <tfoot>
            <tr style="font-weight: bold">
                <!-- <td colspan="3" style="text-align:right;">Total Qty</td>
        <td>{{ invoiceForm.get('p_totalqty')?.value }} PCS</td> -->
                <td colspan="7" align="right" style="text-align: right; font-weight: bold">Grand Total</td>
                <td style="font-weight: bold">â‚¹{{ invoiceForm.get('p_totalpayable')?.value | number: '1.2-2' }}</td>
            </tr>
        </tfoot>
    </table>

    <!-- ================= AMOUNT IN WORDS ================= -->
    <div style="padding: 10px; font-size: 10px">
        <strong>Amount Chargeable (in words):</strong>
        <!-- {{ amountInWords }} -->
        
    </div>

    <!-- ================= GST SUMMARY ================= -->
    <table width="100%" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; font-size: 10px; margin-top: 10px">
        <tr style="font-weight: bold; text-align: center">
            <td>Taxable Value</td>
            <td>Rate</td>
            <td>CGST Amount</td>
            <td>Rate</td>
            <td>SGST Amount</td>
            <td>Total Tax Amount</td>
        </tr>

        <tr style="text-align: center">
            <td>â‚¹{{ invoiceForm.get('amount_before_tax')?.value | number: '1.2-2' }}</td>
            <td>9%</td>
            <td>â‚¹{{ invoiceForm.get('cgst_9')?.value | number: '1.2-2' }}</td>
            <td>9%</td>
            <td>â‚¹{{ invoiceForm.get('sgst_9')?.value | number: '1.2-2' }}</td>
            <td>â‚¹{{ invoiceForm.get('tax_18')?.value | number: '1.2-2' }}</td>
            <!-- sgst_9:billDetails.sgst_9,
      tax_18:billDetails.tax_18,
      cgst_9:billDetails.cgst_9,
      amount_before_tax:billDetails.amount_before_tax, -->
        </tr>
    </table>

    <!-- ================= BANK DETAILS ================= -->
    <div>
    <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse: collapse; font-size: 10px; margin-top: 5px; border: none;">
        <tr>
            <!-- LEFT COLUMN -->
            <td width="70%" style="vertical-align: top; padding: 0; border: none;">
                <div style="margin-bottom: 10px;">
                    <strong>Tax Amount (in words):</strong> <!-- {{ taxAmountInWords }} --> -
                </div>
                
                <div >
                    <strong>Company's Bank Details</strong><br />
                    Bank Name: <b>{{ bankname }}</b><br />
                    A/c No.: {{ accountno }}<br />
                    Branch: {{ branchname }}<br />
                    IFSC: {{ ifsc }}<br />
                    PAN: <b>{{ pan }}</b>
                </div>
            </td>
            </tr>
            <tr>
            <!-- RIGHT COLUMN (Signature) -->
            <td width="30%" style="padding: 0; border: none; text-align: right;">
                <div style=" display: flex; flex-direction: column;justify-content: flex-end;">
                    <strong>Authorized Signatory</strong><br />
                </div>
            </td>
        </tr>
    </table>
     <div style="margin-top: 2px; font-size: 10px;">
                    <strong>Declaration:</strong> This invoice shows the actual price of goods and all particulars are true.
                </div>
</div>
</div>
