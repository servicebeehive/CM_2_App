<div class="card p-6">

  <!-- ================================
       SALES FORM SECTION
  ================================= -->
  <form [formGroup]="salesForm" (ngSubmit)="onSubmit()" class="space-y-8">

    <!-- ================================
         HEADER + ACTION BUTTONS
    ================================= -->
    <div class="flex justify-between items-center mb-6">
      <span class="block text-surface-900 font-bold text-xl mb-6">Sales</span>

      <div class="flex gap-4">

        <!-- RESET -->
        <button
          pButton
          type="button"
          label="Reset"
          class="p-button-secondary"
          (click)="onReset()">
        </button>

        <!-- PRINT -->
        <button
          pButton
          type="button"
          ngxPrint
          printSectionId="invoicePrintSection"
          label="Print"
          class="p-button-primary"
          [disabled]="isPrintDisabled"
          >
        </button>

        <!-- SUBMIT -->
        <button
          pButton
          type="submit"
          label="Submit"
          class="p-button-warning"
          [disabled]="isSubmitDisabled() || submitDisabledByBill">
        </button>

      </div>
    </div>


    <!-- ================================
         ITEM SELECT SECTION
    ================================= -->
    <div class="grid grid-cols-2 gap-x-8 gap-y-4 w-full">

      <!-- ITEM DROPDOWN -->
      <div class="flex flex-col">
        <label>Item</label>

        <p-select
          #itemSel
          class="w-full mb-4"
          [options]="itemOptions"
          optionLabel="itemcombine"
          optionValue="itemid"
          formControlName="p_itemdata"
          [filter]="true"
          filterBy="itemcombine"
          placeholder="Select Item"
          [showClear]="true"
          (onChange)="OnItemChange($event)"
          [disabled]="submitDisabledByBill">

          <!-- Selected Template -->
          <ng-template #selectedItem let-item>
            <div class="flex items-center gap-2">
              <div>{{ item.itemcombine }}</div>
            </div>
          </ng-template>

          <!-- Dropdown Template -->
          <ng-template #item let-details>
            <div class="flex items-center justify-between w-full">
  <div>{{ details.itemcombine }}</div>

 <span
  class="text-sm"
  [ngClass]="details.currentstock == 0 
    ? 'text-red-500' 
    : 'text-green-600'"
>
  Stock: {{ details.currentstock }}
</span>
</div>

          </ng-template>

        </p-select>
      </div>
  <!-- GST CHECKBOX -->
      <div class="flex flex-col mt-8">
        <div class="flex items-center gap-2">
          <p-checkbox binary="true" variant="filled" formControlName="p_gsttran"></p-checkbox>
          <label>GST Transaction</label>
        </div>
      </div>
    </div>


    <!-- ================================
         BILL DETAILS + CUSTOMER INFO
    ================================= -->
    <div class="grid grid-cols-2 gap-x-8 gap-y-4 w-full">

      <!-- BILL NO -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Bill No</label>

        <p-dropdown
          [options]="billNoOptions"
          optionLabel="billno"
          optionValue="billno"
          placeholder="Bill No."
          formControlName="p_billno"
          [filter]="true"
          filterPlaceholder="Search Bill No."
          [showClear]="true" 
          (onChange)="onBillDetails($event)">
        </p-dropdown>

        <small class="text-red-500 mt-1" *ngIf="salesForm.get('p_billno')?.touched">
          <span *ngIf="salesForm.get('p_billno')?.errors?.['required']">
            Bill No is required
          </span>
        </small>
      </div>

      <!-- TRANSACTION DATE -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Transaction Date</label>
        <p-datepicker
          fluid
          formControlName="p_transactiondate"
          dateFormat="dd-mm-yy"
          [showIcon]="true"
          placeholder="Transaction Date"
          [maxDate]="today">
        </p-datepicker>
      </div>


      <!-- CUSTOMER NAME -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Customer Name</label>
        <input
          pInputText
          placeholder="Customer Name"
          formControlName="p_customername" />
      </div>

      <!-- MOBILE -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Mobile No.</label>
        <input
          pInputText
          type="number"
          placeholder="Mobile No."
          maxlength="10"
          formControlName="p_mobileno" 
          (keypress)="allowOnlyNumbers($event)"/>

        <small class="text-red-500 mt-1" *ngIf="salesForm.get('p_mobileno')?.errors?.['pattern'] ">
          Please enter a valid 10-digit mobile number
        </small>
      </div>

    

    </div>


    <!-- ================================
         SALES TABLE (FormArray)
    ================================= -->
    <div class="mt-6">

      <p-table
        [value]="saleArray.controls"
        dataKey="ItemId"
        [responsiveLayout]="'scroll'"
        [paginator]="true"
                        [rows]="10"
         [rowsPerPageOptions]="[5, 10, 20, 50]"
        class="p-datatable-gridlines mt-6">

        <!-- HEADER -->
        <ng-template pTemplate="header">
          <tr class="bg-yellow-400">
            <th><p-tableHeaderCheckbox disabled></p-tableHeaderCheckbox></th>
            <th>Item Code</th>
            <th>Item Name</th>
            <th>Current Stock</th>
            <th>UOM</th>
            <th>Qty</th>
            <th>MRP</th>
            <th>Total</th>
            <th>Warranty</th>
            <th>Location</th>
            <th class="text-center">Action</th>
          </tr>
        </ng-template>

        <!-- ROWS -->
        <ng-template pTemplate="body" let-row let-i="rowIndex">
          <tr [formGroup]="row">
              <td class="text-center"><p-tableCheckbox disabled></p-tableCheckbox></td>
            <td>{{ row.get('itemsku')?.value }}</td>
            <td>{{ row.get('ItemName')?.value }}</td>
            <td>{{ row.get('curStock')?.value }}</td>
            <td>
              
               <p-dropdown
          [options]="uomlist[i]"
          optionLabel="fieldname"
          optionValue="fieldid"
          placeholder="UOM"
          formControlName="UOMId"
          [filter]="true"
          filterPlaceholder="Search Uom name"
           appendTo="body"
          (onChange)="UOMId(row,i)">
        </p-dropdown>
              <!-- {{ row.get('UOMId')?.value }} -->


            </td>

            <!-- QUANTITY INPUT -->
            <td>
              <input
                pInputText
                type="number"
                formControlName="Quantity"
                min="1"
                step="1"
                class="w-[70px]"
                (keypress)="blockDecimal($event)"
                (input)="updateTotal(i)" (input)="OnQtyChange(i)"
                [ngClass]="{ 'border-red-500': row.get('Quantity')?.errors?.['maxStock'] }" />
            </td>

            <td>{{ row.get('MRP')?.value }}</td>
            <td>{{ row.get('totalPayable')?.value }}</td>
            <td>{{ row.get('warPeriod')?.value }}</td>
            <td>{{ row.get('location')?.value }}</td>

            <!-- DELETE -->
            <td class="text-center">
              <i
                class="pi pi-trash text-red-500 cursor-pointer"
                (click)="removeItem(i)">
              </i>
            </td>

          </tr>
        </ng-template>

        <!-- FOOTER TEXT -->
        <ng-template pTemplate="paginatorleft">
          <div class="text-gray-600 ms-2">
            Total Items: {{ saleArray.length }}
          </div>
        </ng-template>

      </p-table>
    </div>


    <!-- ================================
         SUMMARY SECTION
    ================================= -->
    <div class="grid grid-cols-6 gap-x-8 gap-y-4 m-3 mt-4">

      <!-- Total Cost -->
      <div class="flex flex-col">
        <label>Total Cost</label>
        <input pInputText readonly type="number" formControlName="p_totalcost" />
      </div>

      <!-- MRP Total -->
      <div class="flex flex-col">
        <label>MRP Total</label>
        <input pInputText readonly type="number" formControlName="p_totalsale" />
      </div>
 <div class="grid grid-cols-1 md:grid-cols-2">
      <!-- Discount type -->
        <div class="flex flex-col">
          <label class="font-medium mb-2">Disc(%)</label>
          <p-checkbox class="w-5 h-5" binary="true" variant="filled" formControlName="p_disctype"></p-checkbox>
        </div>
      <!-- Discount -->
      <div class="flex flex-col ">
        <label class="font-medium">Discount</label>
        <input class="p-inputtext p-component font-small w-full" pInputText type="number" formControlName="p_overalldiscount" (input)="applyDiscount()" [placeholder]="discountplace"/>
      </div>
</div>
      <!-- Round Off -->
      <div class="flex flex-col">
        <label>Round Off</label>
        <input pInputText readonly type="number" formControlName="p_roundoff" />
      </div>

      <!-- Total Sale -->
      <div class="flex flex-col">
        <label>Total Sale</label>
        <input pInputText readonly type="number" formControlName="p_totalsale" />
      </div>

      <!-- Final Payable -->
      <div class="flex flex-col">
        <label>Final Payable</label>
        <input pInputText readonly type="number" formControlName="p_totalpayable" />
      </div>

    </div>

  </form>

  <p-confirmDialog></p-confirmDialog>

</div>


<!-- ================================
     PRINT SECTION (INVOICE)
================================= -->
<div id="invoicePrintSection">

  <div class="invoice-container" style="width:800px;margin:auto;font-family:Arial;">

    <h2 style="text-align:center;margin-bottom:5px;">SHRISTI ELECTRICAL</h2>

    <p style="text-align:center;margin:0;">
      SHOP NO.-7 SAPNA TALKIES COMPLEX,<br>
      NANDINI ROAD, BHILAI<br>
      GSTIN : 22AOCPY0439F1Z5 | State Code: 22<br>
      Email : {{'shristielectricalgw@gmail.com'}}
    </p>

    <hr />

    <h3 style="text-align:center;margin:0;">TAX INVOICE</h3>

    <!-- HEADER INFO -->
    <table width="100%" style="margin-top:15px;">
      <tr>
        <td>
          <strong>Invoice No:</strong> {{ salesForm.get('p_transactionid')?.value }}<br>
          <strong>Date:</strong> {{ salesForm.get('p_transactiondate')?.value | date:'dd/MM/yyyy' }}
        </td>

        <td>
          <strong>Buyer (Bill To):</strong><br>
          {{ salesForm.get('p_customername')?.value }}<br>
          Mobile: {{ salesForm.get('p_mobileno')?.value }}
        </td>
      </tr>
    </table>

    <hr />

    <!-- PRINT TABLE -->
    <table width="100%" border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse;">
      <thead>
        <tr style="background:#f0f0f0;">
          <th>#</th>
          <th>Description</th>
          <th>HSN</th>
          <th>Qty</th>
          <th>Rate</th>
          <th>Total</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let item of saleRows; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ item.get('ItemName')?.value }}</td>
          <td>—</td>
          <td>{{ item.get('Quantity')?.value }}</td>
          <td>{{ item.get('MRP')?.value }}</td>
          <td>{{ item.get('totalPayable')?.value }}</td>
        </tr>
      </tbody>
    </table>

    <hr />

    <!-- PRINT SUMMARY -->
    <table width="100%" style="margin-top:10px;">

   <tr>
  <td><strong>Total Cost:</strong></td>
  <td>₹ {{ salesForm.get('p_totalcost')?.value }}</td>
</tr>

<tr>
  <td><strong>Total Sale (MRP Total):</strong></td>
  <td>₹ {{ salesForm.get('p_totalsale')?.value }}</td>
</tr>

<tr>
  <td><strong>Discount:</strong></td>
  <td>
    {{ salesForm.get('p_overalldiscount')?.value }}
    {{ salesForm.get('p_disctype')?.value ? '%' : '' }}
  </td>
</tr>

<tr>
  <td><strong>Round Off:</strong></td>
  <td>₹ {{ salesForm.get('p_roundoff')?.value }}</td>
</tr>

<tr>
  <td><strong>Final Payable:</strong></td>
  <td><strong>₹ {{ salesForm.get('p_totalpayable')?.value }}</strong></td>
</tr>


    </table>

    <hr />

    <p style="text-align:right;margin-top:50px;">
      <strong>Authorized Signatory</strong>
    </p>

  </div>

</div> 