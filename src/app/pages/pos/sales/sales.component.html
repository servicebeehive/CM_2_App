<div class="card p-6">

  <!-- ================================
       SALES FORM SECTION
  ================================= -->
  <form [formGroup]="salesForm" (ngSubmit)="onSubmit()" class="space-y-8">

    <!-- ================================
         HEADER + ACTION BUTTONS
    ================================= -->
    <div class="flex justify-between items-center mb-6">
      <span class="block text-surface-900 font-bold text-xl mb-6">Sales</span>

      <div class="flex gap-4">

        <!-- SUBMIT -->
        <button
          pButton
          type="submit"
          label="Submit"
          class="p-button-warning"
          [disabled]="isSubmitDisabled() || submitDisabledByBill || salesForm.hasError('costNotGreater')">
        </button>
        <!-- PRINT -->
        <button
          pButton
          type="button"
          ngxPrint
          printSectionId="invoicePrintSection"
          label="Print" (click)="printInvoice()"
          class="p-button-primary"
          [disabled]="!this.salesForm.get('p_billno')?.value"
          >
        </button>

       
         <!-- RESET -->
        <button
          pButton
          type="button"
          label="Reset"
          class="p-button-secondary"
          (click)="onReset()">
        </button>


      </div>
    </div>


    <!-- ================================
         ITEM SELECT SECTION
    ================================= -->
    <div class="grid grid-cols-2 gap-x-8 gap-y-4 w-full">

      <!-- ITEM DROPDOWN -->
      <div class="flex flex-col">
        <label>Item</label>

        <p-select
          #itemSel
          class="w-full mb-4"
          [options]="itemOptions"
          optionLabel="itemcombine"
          optionValue="itemid"
          formControlName="p_itemdata"
          [filter]="true"
          filterBy="itemcombine"
          placeholder="Select Item"
          [showClear]="true"
          (onChange)="OnItemChange($event)"
          [disabled]="submitDisabledByBill">

          <!-- Selected Template -->
          <ng-template #selectedItem let-item>
            <div class="flex items-center gap-2">
              <div>{{ item.itemcombine }}</div>
            </div>
          </ng-template>

          <!-- Dropdown Template -->
          <ng-template #item let-details>
            <div class="flex items-center justify-between w-full">
  <div>{{ details.itemcombine }}</div>

 <span
  class="text-sm"
  [ngClass]="details.currentstock == 0 
    ? 'text-red-500' 
    : 'text-green-600'"
>
  Stock: {{ details.currentstock }}
</span>
</div>

          </ng-template>

        </p-select>
      </div>
  <!-- GST CHECKBOX -->
      <div class="flex flex-col mt-8">
        <div class="flex items-center gap-2">
          <p-checkbox binary="true" variant="filled" formControlName="p_gsttran"></p-checkbox>
          <label>GST Transaction</label>
        </div>
      </div>
    </div>


    <!-- ================================
         BILL DETAILS + CUSTOMER INFO
    ================================= -->
    <div class="grid grid-cols-2 gap-x-8 gap-y-4 w-full">

      <!-- BILL NO -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Bill No</label>

        <p-dropdown
          [options]="billNoOptions"
          optionLabel="billno"
          optionValue="billno"
          placeholder="Bill No."
          formControlName="p_billno"
          [filter]="true"
          filterPlaceholder="Search Bill No."
          [showClear]="true" 
          (onChange)="onBillDetails($event)">
        </p-dropdown>

        <small class="text-red-500 mt-1" *ngIf="salesForm.get('p_billno')?.touched">
          <span *ngIf="salesForm.get('p_billno')?.errors?.['required']">
            Bill No is required
          </span>
        </small>
      </div>

      <!-- TRANSACTION DATE -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Transaction Date</label>
        <p-datepicker
          fluid
          formControlName="p_transactiondate"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          placeholder="Transaction Date"
          [maxDate]="today">
        </p-datepicker>
      </div>


      <!-- CUSTOMER NAME -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Customer Name</label>
        <input
          pInputText
          placeholder="Customer Name"
          formControlName="p_customername" />
      </div>

      <!-- MOBILE -->
      <div class="flex flex-col">
        <label class="font-medium mb-1">Mobile No.</label>
        <input
          pInputText
          type="number"
          placeholder="Mobile No."
          maxlength="10"
          formControlName="p_mobileno" 
          (keypress)="allowOnlyNumbers($event)"/>

        <small class="text-red-500 mt-1" *ngIf="salesForm.get('p_mobileno')?.errors?.['pattern'] ">
          Please enter a valid 10-digit mobile number
        </small>
      </div>

    

    </div>


    <!-- ================================
         SALES TABLE (FormArray)
    ================================= -->
    <div class="mt-6">

      <p-table
        [value]="saleArray.controls"
        dataKey="ItemId"
        [responsiveLayout]="'scroll'"
        [paginator]="true"
                        [rows]="10"
         [rowsPerPageOptions]="[5, 10, 20, 50]"
        class="p-datatable-gridlines mt-6 sale-report">

        <!-- HEADER -->
        <ng-template pTemplate="header">
          <tr class="bg-yellow-400">
            <th>Item Code</th>
            <th>Item Name</th>
            <th>Current Stock</th>
            <th>UOM</th>
            <th>Qty</th>
            <th>MRP</th>
            <th>Total</th>
            <th>Warranty</th>
            <th>Location</th>
            <th class="text-center">Action</th>
          </tr>
        </ng-template>

        <!-- ROWS -->
        <ng-template pTemplate="body" let-row let-i="rowIndex">
          <tr [formGroup]="row">
            <td>{{ row.get('itemsku')?.value }}</td>
            <td>{{ row.get('ItemName')?.value }}</td>
            <td>{{ row.get('curStock')?.value }}</td>
            <td>
              
               <p-dropdown
          [options]="uomlist[i]"
          optionLabel="fieldname"
          optionValue="fieldid"
          placeholder="UOM"
          formControlName="UOMId"
          [filter]="true"
          filterPlaceholder="Search Uom name"
           appendTo="body"
          (onChange)="UOMId(row,i)">
        </p-dropdown>
              <!-- {{ row.get('UOMId')?.value }} -->


            </td>

            <!-- QUANTITY INPUT -->
            <td>
              <input
                pInputText
                type="number"
                formControlName="Quantity"
                min="1"
                step="1"
                class="w-[70px]"
                (keypress)="blockDecimal($event)"
                (input)="updateTotal(i)" (input)="OnQtyChange(i)"
                [ngClass]="{ 'border-red-500': row.get('Quantity')?.errors?.['maxStock'] }" />
            </td>

            <td>{{ row.get('MRP')?.value }}</td>
            <td>{{ row.get('totalPayable')?.value }}</td>
            <td>{{ row.get('warPeriod')?.value }}</td>
            <td>{{ row.get('location')?.value }}</td>

            <!-- DELETE -->
            <td class="text-center">
              <i
                class="pi pi-trash text-red-500 cursor-pointer"
                (click)="removeItem(i)">
              </i>
            </td>

          </tr>
        </ng-template>

        <!-- FOOTER TEXT -->
        <ng-template pTemplate="paginatorleft">
          <div class="text-gray-600 ms-2">
            Total Items: {{ saleArray.length }}
          </div>
        </ng-template>

      </p-table>
    </div>


    <!-- ================================
         SUMMARY SECTION
    ================================= -->
    <div class="grid grid-cols-6 gap-x-8 gap-y-4 m-3 mt-4">

      <!-- Total Cost -->
      <div class="flex flex-col">
        <label>Total Cost</label>
        <input pInputText readonly type="number" formControlName="p_totalcost" />
      </div>

      <!-- MRP Total -->
      <div class="flex flex-col">
        <label>MRP Total</label>
        <input pInputText readonly type="number" formControlName="p_totalsale" />
      </div>
 <div class="grid grid-cols-1 md:grid-cols-2">
      <!-- Discount type -->
        <div class="flex flex-col">
          <label class="font-medium mb-2">Disc(%)</label>
          <p-checkbox class="w-5 h-5" binary="true" variant="filled" formControlName="p_disctype"></p-checkbox>
        </div>
      <!-- Discount -->
      <div class="flex flex-col ">
        <label class="font-medium">Discount</label>
        <input class="p-inputtext p-component font-small w-full" pInputText type="number" formControlName="p_overalldiscount" (input)="applyDiscount()" [placeholder]="discountplace"/>
      </div>
</div>
      <!-- Round Off -->
      <div class="flex flex-col">
        <label>Round Off</label>
        <input type="number" pInputText readonly type="number" formControlName="p_roundoff" />
      </div>

      <!-- Total Sale -->
      <div class="flex flex-col">
        <label>Total Sale</label>
        <input pInputText readonly type="number" formControlName="p_totalsale" />
      </div>

      <!-- Final Payable -->
      <div class="flex flex-col">
        <label>Final Payable</label>
        <input pInputText readonly type="number" formControlName="p_totalpayable" />
        <small class="text-red-500" 
       *ngIf="salesForm.hasError('costNotGreater')">
  This Cost must be greater than Total Cost.
</small>
      </div>

    </div>

  </form>

  <p-confirmDialog></p-confirmDialog>

</div>


<!-- ================================
     PRINT SECTION (INVOICE)
================================= -->
<div id="invoicePrintSection" style="width:900px; margin:auto; font-family:Arial;">

  <h3 style="text-align: center;">TAX INVOICE</h3>

  <!-- ================= HEADER SECTION ================= -->
  <table width="100%" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
    <tr>

      <!-- LEFT SIDE (COMPANY + BUYER INFO) -->
      <td width="60%" style="vertical-align:top; padding: 6px;">

        <strong>SHRISTI ELECTRICAL</strong><br>
        SHOP NO.-7 SAPNA TALKIES COMPLEX,<br>
        NANDINI ROAD, BHILAI<br>
        GSTIN/UIN: 22AOCPY0439F1Z5<br>
        State Name: Chhattisgarh, Code: 22<br>
        E-Mail : {{'shristielectricalgw@gmail.com'}}
        <br>

        <hr style="margin:5px 0;">

        <strong>Buyer (Bill to)</strong><br><br>

        <strong>{{ salesForm.get('p_customername')?.value }}</strong><br>
        {{ salesForm.get('p_customeraddress')?.value }}<br>
        Mobile: {{ salesForm.get('p_mobileno')?.value }}<br>
        <br>

        GSTIN/UIN : {{ salesForm.get('p_customergstin')?.value || '-' }}<br>
        State Name : {{ salesForm.get('p_customerstate')?.value || '-' }}
      </td>

      <!-- RIGHT SECTION (INVOICE DETAILS) -->
      <td width="40%" style="vertical-align:top;">
        <table width="100%" border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;">

          <tr>
            <td><strong>Invoice No.</strong></td>
            <td>{{ salesForm.get('p_billno')?.value }}</td>
          </tr>

          <tr>
            <td><strong>Dated</strong></td>
            <td>{{ salesForm.get('p_transactiondate')?.value | date:'dd-MMM-yy' }}</td>
          </tr>

          <tr>
            <td>Delivery Note</td>
            <td>-</td>
          </tr>

          <tr>
            <td><strong>Mode/Terms of Payment</strong></td>
            <td><strong>BALANCE</strong></td>
          </tr>

          <tr>
            <td>Reference No. & Date</td>
            <td>{{ salesForm.get('p_transactionid')?.value }} dt. {{ salesForm.get('p_transactiondate')?.value | date:'dd-MMM-yy' }}</td>
          </tr>

          <tr>
            <td>Other References</td>
            <td>-</td>
          </tr>

          <tr>
            <td>Buyer's Order No.</td>
            <td>-</td>
          </tr>

          <tr>
            <td>Dated</td>
            <td>-</td>
          </tr>

          <tr>
            <td>Dispatch Doc No.</td>
            <td>-</td>
          </tr>

          <tr>
            <td>Delivery Note Date</td>
            <td>-</td>
          </tr>

          <tr>
            <td>Dispatched through</td>
            <td>-</td>
          </tr>

          <tr>
            <td>Destination</td>
            <td>-</td>
          </tr>

          <tr>
            <td>Terms of Delivery</td>
            <td>-</td>
          </tr>

        </table>
      </td>

    </tr>
  </table>

  <!-- ================= ITEM TABLE ================= -->
  <table width="100%" border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse;font-size:14px;margin-top:10px;">
    <thead>
      <tr style="text-align:center;font-weight:bold;">
        <td>Sl No.</td>
        <td>Description of Goods</td>
        <td>HSN/SAC</td>
        <td>Quantity</td>
        <td>Rate</td>
        <td>per</td>
        <td>Disc %</td>
        <td>Amount</td>
      </tr>
    </thead>

    <tbody>

      <tr *ngFor="let item of saleRows; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ item.get('ItemName')?.value }}</td>
        <td>{{ item.get('HSN')?.value || 8544 }}</td>
        <td>{{ item.get('Quantity')?.value }} PCS</td>
        <td>{{ item.get('MRP')?.value | number:'1.2-2' }}</td>
        <td>PCS</td>
        <td>{{ item.get('discount')?.value || '' }}</td>
        <td>{{ item.get('totalPayable')?.value | number:'1.2-2' }}</td>
      </tr>

      <!-- SUB TOTAL -->
      <tr>
        <td colspan="7" style="text-align:right;font-weight:bold;">Sub Total</td>
        <td>{{ salesForm.get('p_totalsale')?.value | number:'1.2-2' }}</td>
      </tr>

      <!-- CGST -->
      <tr>
        <td colspan="7" style="text-align:right;"><b>CGST</b></td>
        <td>{{ salesForm.get('p_cgst')?.value }}</td>
      </tr>

      <!-- SGST -->
      <tr>
        <td colspan="7" style="text-align:right;"><b>SGST</b></td>
        <td>{{ salesForm.get('p_sgst')?.value }}</td>
      </tr>

      <!-- ROUND OFF -->
      <tr>
        <td colspan="7" style="text-align:right;"><b>ROUND OFF +/-</b></td>
        <td>{{ salesForm.get('p_roundoff')?.value }}</td>
      </tr>

    </tbody>

    <!-- GRAND TOTAL -->
    <tfoot>
      <tr style="font-weight:bold;">
        <td colspan="3" style="text-align:right;">Total Qty</td>
        <td>{{ salesForm.get('p_totalqty')?.value }} PCS</td>
        <td colspan="3"></td>
        <td>â‚¹ {{ salesForm.get('p_totalpayable')?.value }}</td>
      </tr>
    </tfoot>
  </table>

  <!-- ================= AMOUNT IN WORDS ================= -->
  <div style="padding:10px;font-size:14px;">
    <strong>Amount Chargeable (in words):</strong>
    <!-- {{ amountInWords }} --> -
  </div>

  <!-- ================= GST SUMMARY ================= -->
  <table width="100%" border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse;font-size:14px;margin-top:10px;">
    <tr style="font-weight:bold;text-align:center;">
      <td>HSN/SAC</td>
      <td>Taxable Value</td>
      <td>Rate</td>
      <td>CGST Amount</td>
      <td>Rate</td>
      <td>SGST Amount</td>
      <td>Total Tax Amount</td>
    </tr>

    <tr style="text-align:center;">
      <td>8544</td>
      <td>{{ salesForm.get('p_totalsale')?.value }}</td>
      <td>9%</td>
      <td>{{ salesForm.get('p_cgst')?.value }}</td>
      <td>9%</td>
      <td>{{ salesForm.get('p_sgst')?.value }}</td>
      <td>{{ salesForm.get('p_cgst')?.value + salesForm.get('p_sgst')?.value }}</td>
    </tr>
  </table>

  <!-- ================= BANK DETAILS ================= -->
  <div style="padding:10px;font-size:14px;">

    <strong>Tax Amount (in words):</strong> 
    <!-- {{ taxAmountInWords }} --> -
    <br><br>

    <strong>Company's Bank Details</strong><br>
    Bank Name : <b>BANK OF INDIA</b><br>
    A/c No. : 930520110000557<br>
    Branch & IFS Code : POWER HOUSE & BKID0009305<br><br>

    Company's PAN : <b>AOCPY0439F</b>
    <br><br>

    <strong>Declaration:</strong>
    We declare that this invoice shows the actual price of the goods described and all particulars are true.

    <br><br>
    <p style="text-align:right;"><strong>Authorized Signatory</strong></p>

  </div>

</div>




